# NTP 实验结果报告
> Yitang Yang

## 客户端简介
### 客户端功能
总的来说，客户端的功能是根据用户设定的服务器名与端口请求特定的 ntp 服务器。根据收到的回复计算本机到服务器的 rrt 与本机时间相对于服务器的 offset。一个简单的例子如下：

```sh
$ ./gontp-client -server ntp1.aliyun.com           
client send: 2023-11-13 20:09:25.161569031 +0800 CST m=+0.024689410
server recv: 2023-11-13 20:09:25.000816374 +0800 CST
server send: 2023-11-13 20:09:25.003709105 +0800 CST
client recv: 2023-11-13 20:09:25.21790206 +0800 CST m=+0.081023627

rrt: 49120 (µs)
offset: 25897 (µs)
```

用户可以选择设定 `-settime` 参数以根据 offset 调整本机时间：
```sh
$ sudo ./gontp-client -server ntp1.aliyun.com -settime
```

### 客户端的操作
从代码来讲，客户端首先向指定 ntp 服务器以 ntp 报文的格式发送请求。在此过程中，程序首先使用库函数获取本机系统时间作为 `t1`，并将其转换为 ntp 所使用的定点数形式，与其他参数一起添加到 `NTPMsg` 结构体的对应位置。而 `NTPMsg` 结构体则根据 ntp 报文的格式设定各成员变量的类型和大小。

随后，程序将结构体转换为字节流的形式，并通过网络接口使用 udp 发送到 ntp 服务器。在指定 tiemout 时间内等待 ntp 服务器的回复。收到回复后再次获取此时本机系统时间作为 `t4`，并将回复转换为 `NTPMsg` 结构体的形式。从结构体中取出服务器的时间戳 `t2` 和 `t3`。

之后，根据公式使用 `t1` `t2` `t3` `t4` 计算 rrt 和 offset 时间。为保持精度，计算过程统一将时间转化为微秒进行。

最后，根据 offset 使用 `settimeofday` 系统调用设定系统时间。

## 服务器简介
### 服务器功能
服务器的功能就是及时接收 ntp 请求，并回复发送请求的主机，在回复中加入自己接收到请求和发送回复的时间戳。因为我们并无获取精准时间的渠道，所以对于本服务器，只是通过库函数获取本机时间作为权威的精准时间。

### 服务器的操作
在代码中，服务器随时准备接收来自其他主机的 udp 请求。对于新接收的请求，服务器会判断其是否为 ntp 请求，并为其创建一个 goroutine 进行处理。在此 goroutine 中程序会设定 `NTPMsg` 结构体的参数，并将其转换成字节流形式向请求 ntp 的地址回复。

## 本地互联测试
由于客户端和服务器同样使用本地时间。因此可以在同一主机上运行服务器，并用客户端请求来测试代码的有效性。如果代码正确，则 offset 应当为一很小的数值。

测试结果显示，offset 在本地互联测试中的 offset 为 96 微秒，即 0.000096 秒。

```sh
$ ./gontp-server -port 4567 
2023/11/13 21:00:22 udp address: 0.0.0.0:4567
2023/11/13 21:00:22 start listening ntp requests...
2023/11/13 21:00:45 recv request from 127.0.0.1:35039
```

```shell
$ ./gontp-client -server localhost -port 4567
client send: 2023-11-13 21:00:45.672282834 +0800 CST m=+0.000726694
server recv: 2023-11-13 21:00:45.000090881 +0800 CST
server send: 2023-11-13 21:00:45.000111806 +0800 CST
client recv: 2023-11-13 21:00:45.672555937 +0800 CST m=+0.001000985

rrt: 252 (µs)
offset: 96 (µs)
```
